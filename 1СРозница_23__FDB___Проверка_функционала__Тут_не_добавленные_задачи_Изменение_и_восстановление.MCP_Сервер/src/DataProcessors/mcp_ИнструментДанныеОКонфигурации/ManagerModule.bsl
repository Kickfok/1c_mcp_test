
Процедура ДобавитьИнструменты(Инструменты) Экспорт

	ДобавитьИнструментСписокМетаданных(Инструменты);
	ДобавитьИнструментСтруктураОбъекта(Инструменты);
	ДобавитьИнструментПолучитьВерсиюКонфигурации(Инструменты);
	ДобавитьИнструментПолучитьРолиДоступа(Инструменты);
	ДобавитьИнструментПолучитьНастройкиСеанса(Инструменты);

КонецПроцедуры

Функция ВыполнитьИнструмент(ИмяИнструмента, Аргументы) Экспорт

	Если ИмяИнструмента = "list_metadata_objects" Тогда
		Возврат СписокМетаданных(Аргументы);
	ИначеЕсли ИмяИнструмента = "get_metadata_structure" Тогда
		Возврат СтруктураОбъектаМетаданных(Аргументы);
	ИначеЕсли ИмяИнструмента = "get_configuration_version" Тогда
		Возврат ПолучитьВерсиюКонфигурации(Аргументы);
	ИначеЕсли ИмяИнструмента = "get_access_roles" Тогда
		Возврат ПолучитьРолиДоступа(Аргументы);
	ИначеЕсли ИмяИнструмента = "get_session_parameters" Тогда
		Возврат ПолучитьНастройкиСеанса(Аргументы);
		ВызватьИсключение "Неизвестный инструмент: " + ИмяИнструмента;
	КонецЕсли;

КонецФункции

#Область ИнструментСписокМетаданных

Процедура ДобавитьИнструментСписокМетаданных(Инструменты)

	// Создаем описания параметров для инструмента list_metadata_objects
	МассивПараметров = Новый Массив;
	
	// Параметр metaType - тип объекта метаданных
	СписокТиповМетаданных = "Catalogs,Documents,InformationRegisters,AccumulationRegisters,AccountingRegisters,CalculationRegisters,ChartsOfCharacteristicTypes,ChartsOfAccounts,ChartsOfCalculationTypes,BusinessProcesses,Tasks,ExchangePlans,FilterCriteria,Reports,DataProcessors,Enums,CommonModules,SessionParameters,CommonTemplates,CommonPictures,XDTOPackages,WebServices,HTTPServices,WSReferences,Styles,Languages,FunctionalOptions,FunctionalOptionsParameters,DefinedTypes,CommonAttributes,CommonCommands,CommandGroups,Constants,CommonForms,Roles,Subsystems,EventSubscriptions,ScheduledJobs,SettingsStorages,Sequences,DocumentJournals,ExternalDataSources,Interfaces,CommonModules";
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"metaType",
		"string",
		"Тип объекта метаданных",
		,
		Истина,
		СписокТиповМетаданных
	));
	
	// Параметр nameMask - маска имени в формате регулярного выражения
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"nameMask",
		"string",
		"Маска имени объекта. Проверяется на вхождение подстроки в имя или синоним объекта."
	));
	
	// Параметр maxItems - максимальное количество возвращаемых результатов
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"maxItems",
		"number",
		"Максимальное количество возвращаемых результатов",
		100
	));
	
	// Создаем JSON-схему параметров
	СхемаПараметров = mcp_Метаданные.СхемаПараметровИнструмента(МассивПараметров);
	
	// Добавляем инструмент в таблицу
	mcp_Метаданные.ДобавитьИнструмент(
		Инструменты,
		"list_metadata_objects",
		"Получение списка объектов метаданных конфигурации с возможностью фильтрации по типу и имени",
		СхемаПараметров
	);

КонецПроцедуры

Функция СписокМетаданных(Аргументы)

	// Значения по умолчанию
	МетаТип     = Аргументы.metaType;
	МаскаИмени  = ?(Аргументы.Свойство("nameMask"), Аргументы.nameMask, "");
	Лимит       = ?(Аргументы.Свойство("maxItems"), Аргументы.maxItems, 100);

	МаскаИмениВРег = ВРег(МаскаИмени);

	// Получаем коллекцию нужного типа
	Попытка
		КоллекцияМД = Метаданные[МетаТип];
	Исключение
		ВызватьИсключение "Неизвестный тип метаданных в metaType: " + МетаТип;
	КонецПопытки;

	МассивСтрок = Новый Массив;
	Счетчик = 0;

	Для Каждого Элемент Из КоллекцияМД Цикл
		// Проверяем маску имени, если она задана
		Если ЗначениеЗаполнено(МаскаИмени) Тогда
			// Простая проверка на вхождение подстроки
			Если СтрНайти(ВРег(Элемент.Имя), МаскаИмениВРег) = 0 
				И СтрНайти(ВРег(Элемент.Синоним), МаскаИмениВРег) = 0 Тогда
				Продолжить;
			КонецЕсли;
		КонецЕсли;

		// Формируем строку в формате "ПолноеИмя (Синоним)"
		СтрокаРезультата = Элемент.ПолноеИмя() + " (" + Элемент.Синоним + ")";
		МассивСтрок.Добавить(СтрокаРезультата);
		
		Счетчик = Счетчик + 1;
		Если Счетчик >= Лимит Тогда
			Прервать;
		КонецЕсли;
	КонецЦикла;

	// Объединяем строки через символ перевода строки
	Результат = СтрСоединить(МассивСтрок, Символы.ПС);
	
	Возврат Результат;

КонецФункции

#КонецОбласти

#Область ИнструментСтруктураОбъекта

Процедура ДобавитьИнструментСтруктураОбъекта(Инструменты)

	// Создаем описания параметров для инструмента get_metadata_structure
	МассивПараметров = Новый Массив;
	
	// Параметр metaType - тип объекта метаданных (только те, у которых есть структура)
	СписокТиповМетаданных = "Catalogs,Documents,InformationRegisters,AccumulationRegisters,AccountingRegisters,CalculationRegisters,Reports,DataProcessors,ChartsOfCharacteristicTypes,ChartsOfAccounts,ChartsOfCalculationTypes,BusinessProcesses,Tasks,ExchangePlans";
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"metaType",
		"string",
		"Тип объекта метаданных",
		,
		Истина,
		СписокТиповМетаданных
	));
	
	// Параметр name - точное имя объекта (не зависимое от регистра)
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"name",
		"string",
		"Точное имя объекта метаданных (без учета регистра)",
		,
		Истина
	));
	
	// Создаем JSON-схему параметров
	СхемаПараметров = mcp_Метаданные.СхемаПараметровИнструмента(МассивПараметров);
	
	// Добавляем инструмент в таблицу
	mcp_Метаданные.ДобавитьИнструмент(
		Инструменты,
		"get_metadata_structure",
		"Получение структуры объекта метаданных (реквизиты, табличные части, измерения, ресурсы)",
		СхемаПараметров
	);

КонецПроцедуры

Функция СтруктураОбъектаМетаданных(Аргументы)

	МетаТип = Аргументы.metaType;
	ИмяОбъекта = Аргументы.name;
	
	// Получаем коллекцию нужного типа
	Попытка
		КоллекцияМД = Метаданные[МетаТип];
	Исключение
		ВызватьИсключение "Неизвестный тип метаданных в metaType: " + МетаТип;
	КонецПопытки;
	
	// Ищем объект метаданных по имени (без учета регистра)
	МетаданныеОбъекта = КоллекцияМД.Найти(ИмяОбъекта);
	Если МетаданныеОбъекта = Неопределено Тогда
		ВызватьИсключение "Объект метаданных не найден: " + МетаТип + "." + ИмяОбъекта;
	КонецЕсли;
	
	ОбработкаОбъект = Создать();
	
	Возврат ОбработкаОбъект.ОписаниеСтруктурыОбъектаМетаданных(МетаданныеОбъекта);
	
КонецФункции

#КонецОбласти  

#Область ИнструментПолучитьВерсиюКонфигурации

Процедура ДобавитьИнструментПолучитьВерсиюКонфигурации(Инструменты)

	// Этот инструмент не требует параметров
	МассивПараметров = Новый Массив;
	
	СхемаПараметров = mcp_Метаданные.СхемаПараметровИнструмента(МассивПараметров);
	
	mcp_Метаданные.ДобавитьИнструмент(
		Инструменты,
		"get_configuration_version",
		"Получение информации о версии конфигурации, конфигураторе и платформе",
		СхемаПараметров
	);

КонецПроцедуры

Функция ПолучитьВерсиюКонфигурации(Аргументы)
	
	// Получаем информацию о конфигурации 
	СистемнаяИнформация = Новый("СистемнаяИнформация");
	ВерсияПлатформы = СистемнаяИнформация.ВерсияПриложения;
	НазваниеКонфигурации = Метаданные.Имя; 
	ВерсияКонфигурации = Метаданные.Версия;
	
	// Собираем информацию о конфигураторе
	РежимЗапуска = ТекущийРежимЗапуска();
	ОсновнойЯзык = ПользователиИнформационнойБазы.ТекущийПользователь().Язык.Имя;
	
	// Статистика объектов
	ВсегоОбъектов = 0;
	Для Каждого ТипМетаданных Из Аргументы.metaType Цикл
		ВсегоОбъектов = ВсегоОбъектов + Метаданные[ТипМетаданных].Количество();
	КонецЦикла;
	
	Результат = "ИНФОРМАЦИЯ О КОНФИГУРАЦИИ
	| ================================
	| Версия платформы: " + ВерсияПлатформы + "
	| Название конфигурации: " + НазваниеКонфигурации + "
	| Версия конфигурации: " + ВерсияКонфигурации + "
	| 
	| ОБЩИЕ НАСТРОЙКИ:
	| Режим запуска: " + РежимЗапуска + "
	| Основной язык: " + ОсновнойЯзык + "
	| 
	| СТАТИСТИКА ОБЪЕКТОВ:
	| Справочники: " + Метаданные["Catalogs"].Количество() + "
	| Документы: " + Метаданные["Documents"].Количество() + "
	| Регистры сведений: " + Метаданные["InformationRegisters"].Количество() + "
	| Регистры накопления: " + Метаданные["AccumulationRegisters"].Количество() + " 
	| Регистры бухгалтерии: " + Метаданные["AccountingRegisters"].Количество() + "
	| Регистры расчета: " + Метаданные["CalculationRegisters"].Количество() + "
	| Планы видов характеристик: " + Метаданные["ChartsOfCharacteristicTypes"].Количество() + "
	| Планы счетов: " + Метаданные["ChartsOfAccounts"].Количество() + "
	| Планы видов расчета: " + Метаданные["ChartsOfCalculationTypes"].Количество() + "
	| Бизнес процессы: " + Метаданные["BusinessProcesses"].Количество() + "
	| Задачи: " + Метаданные["Tasks"].Количество() + " 
	| Планы обмена: " + Метаданные["ExchangePlans"].Количество() + "
	| Критерии отбороа: " + Метаданные["FilterCriteria"].Количество() + "
	| Отчеты: " + Метаданные["Reports"].Количество() + "
	| Перечисления: " + Метаданные["Enums"].Количество() + "
	| Общие модули: " + Метаданные["CommonModules"].Количество() + "
	| Обработки: " + Метаданные["DataProcessors"].Количество() + "
	| Общие модули: " + Метаданные["ОбщиеМодули"].Количество() + " 
	| Параметры сеанса: " + Метаданные["SessionParameters"].Количество() + "
	| Общие макеты: " + Метаданные["CommonTemplates"].Количество() + "
	| Общие картинки: " + Метаданные["CommonPictures"].Количество() + "
	| XDTO-пакеты: " + Метаданные["XDTOPackages"].Количество() + "
	| Web-сервисы: " + Метаданные["WebServices"].Количество() + "
	| HTTP-сервисы: " + Метаданные["HTTPServices"].Количество() + "
	| WS-ссылки: " + Метаданные["WSReferences"].Количество() + "
	| Стили: " + Метаданные["Styles"].Количество() + " 
	| Языки: " + Метаданные["Languages"].Количество() + "
    | Функциональные опции: " + Метаданные["FunctionalOptions"].Количество() + "
	| Параметры функциональных опций: " + Метаданные["FunctionalOptionsParameters"].Количество() + "
    | Константы: " + Метаданные["Constants"].Количество() + "
	| Общие формы: " + Метаданные["CommonForms"].Количество() + "
    | Роли: " + Метаданные["Roles"].Количество() + "
	| Определяемые типы: " + Метаданные["DefinedTypes"].Количество() + "
    | Общие реквизиты: " + Метаданные["CommonAttributes"].Количество() + "
	| Общие команды: " + Метаданные["CommonCommands"].Количество() + "
    | Группы команд: " + Метаданные["CommandGroups"].Количество() + "
	| Подсистемы: " + Метаданные["Subsystems"].Количество() + "
	| Подписки на события: " + Метаданные["EventSubscriptions"].Количество() + " 
	| Регламентные задания: " + Метаданные["ScheduledJobs"].Количество() + "
	| Хранилища настроек: " + Метаданные["SettingsStorages"].Количество() + "
	| Последовательность: " + Метаданные["Sequences"].Количество() + "
	| Журналы документов: " + Метаданные["DocumentJournals"].Количество() + "
	| Интерфейсы: " + Метаданные["Interfaces"].Количество() + "
	| Общие модули: " + Метаданные["CommonModules"].Количество() + "
	| Планы обмена: " + Метаданные["ExternalDataSources"].Количество() + "
	| Константы: " + Метаданные["Константы"].Количество() + "
	| ЖурналыДокументов: " + Метаданные["ЖурналыДокументов"].Количество();
	
	Возврат Результат;

КонецФункции

#КонецОбласти 

#Область ИнструментПолучитьРолиДоступа

Процедура ДобавитьИнструментПолучитьРолиДоступа(Инструменты)

	МассивПараметров = Новый Массив;
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"roleName",
		"string",
		"Имя роли для фильтрации (опционально)"
	));
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"includePermissions",
		"boolean",
		"Включать подробные права доступа",
		Ложь
	));
	
	СхемаПараметров = mcp_Метаданные.СхемаПараметровИнструмента(МассивПараметров);
	
	mcp_Метаданные.ДобавитьИнструмент(
		Инструменты,
		"get_access_roles",
		"Получение списка ролей доступа с их правами",
		СхемаПараметров
	);

КонецПроцедуры

Функция ПолучитьРолиДоступа(Аргументы)
	
	ИмяРоли = ?(Аргументы.Свойство("roleName"), Аргументы.roleName, "");
	ВключатьПрава = ?(Аргументы.Свойство("includePermissions"), Аргументы.includePermissions, Ложь);
	
	Результат = "СПИСОК РОЛЕЙ ДОСТУПА
	| ================================
	| ";
	
	Для Каждого Роль Из Метаданные.Роли Цикл
		Если ЗначениеЗаполнено(ИмяРоли) И НЕ СтрНайти(ВРег(Роль.Имя), ВРег(ИмяРоли)) > 0 Тогда
			Продолжить;
		КонецЕсли;
		
		Результат = Результат + "
		| Роль: " + Роль.Имя + " (" + Роль.Синоним + ")
		| Описание: " + Роль.Комментарий;
		
		Если ВключатьПрава Тогда
			// Получаем права роли (упрощенно)
			Результат = Результат + "
			| Основные права:";
			
			// Примерная структура прав - в реальности нужно анализировать Права
			Для Каждого Право Из Роль.Права Цикл
				Результат = Результат + " - " + Право.Имя + ": " + Право.ВидПрава;
			КонецЦикла;
		КонецЕсли;
		
		Результат = Результат + "
		| ------------------------------------------------";
	КонецЦикла;
	
	Результат = Результат + "
	| Всего ролей: " + Метаданные.Роли.Количество();
	
	Возврат Результат;

КонецФункции

#КонецОбласти

#Область ИнструментПолучитьНастройкиСеанса

Процедура ДобавитьИнструментПолучитьНастройкиСеанса(Инструменты)

	МассивПараметров = Новый Массив;
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"parameterName",
		"string",
		"Имя параметра сеанса для фильтрации (опционально)"
	));
	
	СхемаПараметров = mcp_Метаданные.СхемаПараметровИнструмента(МассивПараметров);
	
	mcp_Метаданные.ДобавитьИнструмент(
		Инструменты,
		"get_session_parameters",
		"Получение списка параметров сеанса с их значениями",
		СхемаПараметров
	);

КонецПроцедуры

Функция ПолучитьНастройкиСеанса(Аргументы)
	
	ИмяПараметра = ?(Аргументы.Свойство("parameterName"), Аргументы.parameterName, "");
	
	Результат = "ПАРАМЕТРЫ СЕАНСА
	| ===========================";
	
	Для Каждого ПараметрСеанса Из Метаданные.ПараметрыСеанса Цикл
		Если ЗначениеЗаполнено(ИмяПараметра) И НЕ СтрНайти(ВРег(ПараметрСеанса.Имя), ВРег(ИмяПараметра)) > 0 Тогда
			Продолжить;
		КонецЕсли;
		
		Результат = Результат + "
		| Параметр: " + ПараметрСеанса.ПолноеИмя() + "
		| Синоним: " + ПараметрСеанса.Представление();
		
		// Пытаемся получить значение
		Попытка
			Значение = ПараметрСеанса.Получить();
			Результат = Результат + "
			| Значение: " + Строка(Значение);
		Исключение
			Результат = Результат + "
			| Значение: [не доступно]";
		КонецПопытки;
		
		Результат = Результат + "
		| ----------------------------";
	КонецЦикла;
	
	Результат = Результат + "
	| Всего параметров: " + Метаданные.ПараметрыСеанса.Количество();
	
	Возврат Результат;

КонецФункции

#КонецОбласти 

