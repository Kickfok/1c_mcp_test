
Процедура ДобавитьИнструменты(Инструменты) Экспорт
	
	ДобавитьИнструментОборотыПоСчетам(Инструменты);
	ДобавитьИнструментАнализДебиторки(Инструменты);
	ДобавитьИнструментРасчетНДС(Инструменты);
	ДобавитьИнструментМаржинальность(Инструменты);
	ДобавитьИнструментОборачиваемость(Инструменты);
	ДобавитьИнструментАнализДвиженияДС(Инструменты);
	
КонецПроцедуры

Функция ВыполнитьИнструмент(ИмяИнструмента, Аргументы) Экспорт

	Если ИмяИнструмента = "get_account_turnovers" Тогда
		Возврат ОборотыПоСчетам(Аргументы);
	ИначеЕсли ИмяИнструмента = "analyze_accounts_receivable" Тогда
		Возврат АнализДебиторскойЗадолженности(Аргументы);
	ИначеЕсли ИмяИнструмента = "calculate_vat_liability" Тогда
		Возврат РасчетОбязательствПоНДС(Аргументы);
	ИначеЕсли ИмяИнструмента = "calculate_product_margin" Тогда
		Возврат РасчетМаржинальностиПродукции(Аргументы);
	ИначеЕсли ИмяИнструмента = "get_stock_turnover" Тогда
		Возврат РасчетОборачиваемостиЗапасов(Аргументы);
	ИначеЕсли ИмяИнструмента = "get_cash_flow" Тогда
		Возврат АнализДвиженияДенежныхСредств(Аргументы);
	Иначе
		ВызватьИсключение "Неизвестный инструмент: " + ИмяИнструмента;
	КонецЕсли;

КонецФункции

#Область ИнструментОборотыПоСчетам

Процедура ДобавитьИнструментОборотыПоСчетам(Инструменты)

	МассивПараметров = Новый Массив;
	
	// Период
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"periodStart",
		"string",
		"Дата начала периода в формате ГГГГ-ММ-ДД",
		,
		Истина
	));
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"periodEnd",
		"string",
		"Дата окончания периода в формате ГГГГ-ММ-ДД",
		,
		Истина
	));
	
	// Счета (можно диапазон или список)
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"accounts",
		"string",
		"Номера счетов через запятую или диапазон (например: 60-62 или 50,51,52)"
	));
	
	// Организация
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"organization",
		"string",
		"Код или наименование организации"
	));
	
	// Валюта
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"currency",
		"string",
		"Код валюты",
		"руб"
	));
	
	// Детализация
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"detailLevel",
		"string",
		"Уровень детализации: Счета, Субконто, Документы",
		"Счета"
	));
	
	СхемаПараметров = mcp_Метаданные.СхемаПараметровИнструмента(МассивПараметров);
	
	mcp_Метаданные.ДобавитьИнструмент(
		Инструменты,
		"get_account_turnovers",
		"Получение оборотов и остатков по счетам бухгалтерского учета за период",
		СхемаПараметров
	);

КонецПроцедуры

Функция ОборотыПоСчетам(Аргументы)
	
	ПериодНачало = Дата(Аргументы.periodStart);
	ПериодКонец = Дата(Аргументы.periodEnd);
	Счета = ?(Аргументы.Свойство("accounts"), Аргументы.accounts, "");
	Организация = ?(Аргументы.Свойство("organization"), Аргументы.organization, "");
	Валюта = ?(Аргументы.Свойство("currency"), Аргументы.currency, "руб");
	Детализация = ?(Аргументы.Свойство("detailLevel"), Аргументы.detailLevel, "Счета");
	
	// Реализация запроса к бухгалтерским итогам
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	БухгалтерскийИтог.Счет КАК Счет,
	|	БухгалтерскийИтог.СубконтоКт1 КАК СубконтоКт1,
	|	БухгалтерскийИтог.СубконтоКт2 КАК СубконтоКт2,
	|	БухгалтерскийИтог.СубконтоКт3 КАК СубконтоКт3,
	|	БухгалтерскийИтог.КоличествоНачальныйОстаток КАК КоличествоНачальныйОстаток,
	|	БухгалтерскийИтог.СуммаНачальныйОстаток КАК СуммаНачальныйОстаток,
	|	БухгалтерскийИтог.КоличествоОборотДт КАК КоличествоОборотДт,
	|	БухгалтерскийИтог.СуммаОборотДт КАК СуммаОборотДт,
	|	БухгалтерскийИтог.КоличествоОборотКт КАК КоличествоОборотКт,
	|	БухгалтерскийИтог.СуммаОборотКт КАК СуммаОборотКт
	|ИЗ
	|	РегистрБухгалтерии.Хозрасчетный.Итоги(&ПериодНачало, &ПериодКонец, Счет, СубконтоКт1, СубконтоКт2, СубконтоКт3) КАК БухгалтерскийИтог
	|ГДЕ
	|	БухгалтерскийИтог.Счет В ИЕРАРХИИ(&Счета)";
	
	// Заполняем параметры и выполняем запрос
	// ...
	
	// Формируем результат в удобном формате
	Результат = "Счет | Начальный остаток | Оборот Дт | Оборот Кт | Конечный остаток
	| ===========================================================
	| 50.01 | 1000 | 5000 | 4500 | 1500
	| 51   | 50000 | 200000 | 180000 | 70000";
	
	Возврат Результат;
	
КонецФункции

#КонецОбласти 

#Область ИнструментАнализДебиторки

Процедура ДобавитьИнструментАнализДебиторки(Инструменты)

	МассивПараметров = Новый Массив;
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"analysisDate",
		"string",
		"Дата анализа в формате ГГГГ-ММ-ДД",
		,
		Истина
	));
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"organization",
		"string",
		"Организация"
	));
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"counterparties",
		"string",
		"Список контрагентов через запятую (опционально)"
	));
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"agingBuckets",
		"string",
		"Корзины старения в днях через запятую (например: 0,30,60,90)",
		"0,30,60,90,180"
	));
	
	СхемаПараметров = mcp_Метаданные.СхемаПараметровИнструмента(МассивПараметров);
	
	mcp_Метаданные.ДобавитьИнструмент(
		Инструменты,
		"analyze_accounts_receivable",
		"Анализ дебиторской задолженности с разбивкой по срокам просрочки (aging report)",
		СхемаПараметров
	);

КонецПроцедуры

Функция АнализДебиторскойЗадолженности(Аргументы)
	
	ДатаАнализа = Дата(Аргументы.analysisDate);
	Организация = ?(Аргументы.Свойство("organization"), Аргументы.organization, "");
	Контрагенты = ?(Аргументы.Свойство("counterparties"), Аргументы.counterparties, "");
	Корзины = СтрРазделить(?(Аргументы.Свойство("agingBuckets"), Аргументы.agingBuckets, "0,30,60,90,180"), ",", Ложь);
	
	// Реализация анализа задолженности
	// Запрос к регистру накопления Взаиморасчеты или к счетам 62, 76
	
	Результат = "Анализ дебиторской задолженности на " + Формат(ДатаАнализа, "ДФ=dd.MM.yyyy") + "
	| ===========================================================
	| Срок задолженности | Сумма | % от общей | Контрагенты
	| -----------------------------------------------------------
	| Текущая (0-30 дней) | 500 000 | 50% | ООО Ромашка, ИП Иванов
	| Просрочка 31-60 дней | 300 000 | 30% | ООО Лотос
	| Просрочка 61-90 дней | 150 000 | 15% | ЗАО Север
	| Более 90 дней | 50 000 | 5% | ООО Альфа
	| ===========================================================
	| Итого: 1 000 000 руб.";
	
	Возврат Результат;
	
КонецФункции

#КонецОбласти    

#Область ИнструментРасчетНДС

Процедура ДобавитьИнструментРасчетНДС(Инструменты)

	МассивПараметров = Новый Массив;
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"period",
		"string",
		"Период в формате ММ.ГГГГ или ГГГГ-ММ",
		,
		Истина
	));
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"organization",
		"string",
		"Организация",
		,
		Истина
	));
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"includeDetails",
		"boolean",
		"Включать детализацию по документам",
		Ложь
	));
	
	СхемаПараметров = mcp_Метаданные.СхемаПараметровИнструмента(МассивПараметров);
	
	mcp_Метаданные.ДобавитьИнструмент(
		Инструменты,
		"calculate_vat_liability",
		"Расчет налоговых обязательств по НДС за период",
		СхемаПараметров
	);

КонецПроцедуры

Функция РасчетОбязательствПоНДС(Аргументы)
	
	Период = Аргументы.period;
	Организация = Аргументы.organization;
	ВключатьДетализацию = ?(Аргументы.Свойство("includeDetails"), Аргументы.includeDetails, Ложь);
	
	// Расчет НДС к начислению и вычету
	// Анализ счетов 19, 68.02, регистров НДС
	
	Результат = "Расчет НДС за " + Период + "
	| ===========================================================
	| НДС к начислению (исходящий):
	| - Реализация товаров: 180 000 руб.
	| - Реализация услуг: 45 000 руб.
	| - Авансы полученные: 36 000 руб.
	| Итого к начислению: 261 000 руб.
	| 
	| НДС к вычету (входящий):
	| - Приобретение товаров: 120 000 руб.
	| - Приобретение услуг: 18 000 руб.
	| - Авансы выданные: 24 000 руб.
	| Итого к вычету: 162 000 руб.
	| 
	| НДС к уплате: 99 000 руб.
	| 
	| Документы для декларации:
	| 1. Счет-фактура №123 от 15.03.2024 - 180 000 руб.
	| 2. Счет-фактура №124 от 20.03.2024 - 45 000 руб.";
	
	Возврат Результат;
	
КонецФункции

#КонецОбласти

#Область ИнструментМаржинальность

Процедура ДобавитьИнструментМаржинальность(Инструменты)

	МассивПараметров = Новый Массив;
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"periodStart",
		"string",
		"Дата начала периода",
		,
		Истина
	));
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"periodEnd",
		"string",
		"Дата окончания периода",
		,
		Истина
	));
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"productGroups",
		"string",
		"Группы товаров через запятую"
	));
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"groupBy",
		"string",
		"Группировка: Номенклатура, Группа, Подразделение",
		"Номенклатура"
	));
	
	СхемаПараметров = mcp_Метаданные.СхемаПараметровИнструмента(МассивПараметров);
	
	mcp_Метаданные.ДобавитьИнструмент(
		Инструменты,
		"calculate_product_margin",
		"Расчет маржинальности по товарам/группам (выручка, себестоимость, маржа, рентабельность)",
		СхемаПараметров
	);

КонецПроцедуры

Функция РасчетМаржинальностиПродукции(Аргументы)
	
	НачалоПериода = Дата(Аргументы.periodStart);
	КонецПериода = Дата(Аргументы.periodEnd);
	ГруппыТоваров = ?(Аргументы.Свойство("productGroups"), Аргументы.productGroups, "");
	Группировка = ?(Аргументы.Свойство("groupBy"), Аргументы.groupBy, "Номенклатура");
	
	// Запрос к регистрам накопления Продажи и Себестоимость
	
	Результат = "Маржинальность за период " + Формат(НачалоПериода, "ДФ=dd.MM.yyyy") + " - " + Формат(КонецПериода, "ДФ=dd.MM.yyyy") + "
	| =============================================================================================
	| Товар/Группа | Выручка | Себестоимость | Маржа | Рентабельность
	| -----------------------------------------------------------------
	| Ноутбуки     | 1 500 000 | 1 200 000 | 300 000 | 20%
	| Смартфоны    | 2 300 000 | 1 840 000 | 460 000 | 20%
	| Планшеты     | 800 000   | 720 000   | 80 000  | 10%
	| Аксессуары   | 400 000   | 280 000   | 120 000 | 30%
	| -----------------------------------------------------------------
	| Итого        | 5 000 000 | 4 040 000 | 960 000 | 19,2%";
	
	Возврат Результат;
	
КонецФункции

#КонецОбласти  

#Область ИнструментОборачиваемость

Процедура ДобавитьИнструментОборачиваемость(Инструменты)

	МассивПараметров = Новый Массив;
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"periodStart",
		"string",
		"Дата начала периода",
		,
		Истина
	));
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"periodEnd",
		"string",
		"Дата окончания периода",
		,
		Истина
	));
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"warehouses",
		"string",
		"Склады через запятую"
	));
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"productGroups",
		"string",
		"Группы товаров для анализа"
	));
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"turnoverType",
		"string",
		"Тип оборачиваемости: Дни, Разы, Оба",
		"Оба"
	));
	
	СхемаПараметров = mcp_Метаданные.СхемаПараметровИнструмента(МассивПараметров);
	
	mcp_Метаданные.ДобавитьИнструмент(
		Инструменты,
		"get_stock_turnover",
		"Расчет оборачиваемости товарных запасов (в днях и разах)",
		СхемаПараметров
	);

КонецПроцедуры

Функция РасчетОборачиваемостиЗапасов(Аргументы)
	
	НачалоПериода = Дата(Аргументы.periodStart);
	КонецПериода = Дата(Аргументы.periodEnd);
	Склады = ?(Аргументы.Свойство("warehouses"), Аргументы.warehouses, "");
	Группы = ?(Аргументы.Свойство("productGroups"), Аргументы.productGroups, "");
	Тип = ?(Аргументы.Свойство("turnoverType"), Аргументы.turnoverType, "Оба");
	
	// Расчет оборачиваемости по регистру остатков товаров
	
	Результат = "Оборачиваемость запасов за " + Формат(НачалоПериода, "ДФ=MM.yyyy") + "
	| ===========================================================
	| Группа товаров | Средний запас | Продажи | Оборачиваемость (дни) | Оборачиваемость (разы)
	| -----------------------------------------------------------------
	| Электроника   | 2 500 000     | 5 000 000 | 15 дней | 2 раза
	| Бытовая техника| 1 800 000    | 3 600 000 | 15 дней | 2 раза
	| Мебель        | 3 000 000     | 2 400 000 | 38 дней | 0,8 раз
	| Канцелярия    | 200 000       | 800 000   | 8 дней  | 4 раза
	| -----------------------------------------------------------------
	| Норматив: до 30 дней";
	
	Возврат Результат;
	
КонецФункции

#КонецОбласти 

#Область ИнструментАнализДвиженияДС

Процедура ДобавитьИнструментАнализДвиженияДС(Инструменты)

	МассивПараметров = Новый Массив;
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"periodStart",
		"string",
		"Дата начала периода",
		,
		Истина
	));
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"periodEnd",
		"string",
		"Дата окончания периода",
		,
		Истина
	));
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"cashAccounts",
		"string",
		"Счета денежных средств (например: 50,51,52,55)"
	));
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"organization",
		"string",
		"Организация"
	));
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"groupBy",
		"string",
		"Группировка: СтатьяДДС, Контрагент, Документ",
		"СтатьяДДС"
	));
	
	СхемаПараметров = mcp_Метаданные.СхемаПараметровИнструмента(МассивПараметров);
	
	mcp_Метаданные.ДобавитьИнструмент(
		Инструменты,
		"get_cash_flow",
		"Анализ движения денежных средств по кассам и банковским счетам",
		СхемаПараметров
	);

КонецПроцедуры

Функция АнализДвиженияДенежныхСредств(Аргументы)
	
	НачалоПериода = Дата(Аргументы.periodStart);
	КонецПериода = Дата(Аргументы.periodEnd);
	СчетаДС = ?(Аргументы.Свойство("cashAccounts"), Аргументы.cashAccounts, "50,51,52,55");
	Организация = ?(Аргументы.Свойство("organization"), Аргументы.organization, "");
	Группировка = ?(Аргументы.Свойство("groupBy"), Аргументы.groupBy, "СтатьяДДС");
	
	// Анализ движения по счетам 50, 51, 52, 55
	
	Результат = "Движение денежных средств за " + Формат(НачалоПериода, "ДФ=dd.MM.yyyy") + " - " + Формат(КонецПериода, "ДФ=dd.MM.yyyy") + "
	| ========================================================================
	| Направление/Статья          | Приход      | Расход     | Сальдо
	| ----------------------------------------------------------------
	| ОПЕРАЦИОННАЯ ДЕЯТЕЛЬНОСТЬ
	| - Продажа товаров/услуг    | 3 500 000   | 0          | +3 500 000
	| - Оплата поставщикам       | 0           | 2 800 000  | -2 800 000
	| - Зарплата                 | 0           | 700 000    | -700 000
	| - Налоги                   | 0           | 350 000    | -350 000
	| Итого по операционной:     | 3 500 000   | 3 850 000  | -350 000
	| 
	| ИНВЕСТИЦИОННАЯ ДЕЯТЕЛЬНОСТЬ
	| - Покупка ОС               | 0           | 1 200 000  | -1 200 000
	| Итого по инвестиционной:   | 0           | 1 200 000  | -1 200 000
	| 
	| ФИНАНСОВАЯ ДЕЯТЕЛЬНОЛЬНОСТЬ
	| - Получение кредита        | 2 000 000   | 0          | +2 000 000
	| Итого по финансовой:       | 2 000 000   | 0          | +2 000 000
	| 
	| ОБЩЕЕ САЛЬДО: +450 000 руб.
	| 
	| Остаток на начало: 800 000 руб.
	| Остаток на конец:  1 250 000 руб.";
	
	Возврат Результат;
	
КонецФункции

#КонецОбласти





